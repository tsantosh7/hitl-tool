{% extends "base.html" %}
{% block content %}
<h1>Search Documents</h1>

<form method="get" class="card" style="padding:14px;">
  {# keep core sticky #}
  <input type="hidden" name="core" value="{{ core }}">

  {# -------------------- Primary search bar (single row) -------------------- #}
  <div style="display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;">

    <div class="grow" style="display:flex; gap:10px; align-items:stretch; flex:1 1 520px; min-width:320px;">

      <div style="flex: 1 1 auto; min-width:240px;">
        <label class="muted">Search</label>
        <input
          name="kw"
          value="{{ kw or '' }}"
          placeholder="Type keywords (e.g., fraud, sentencing, appeal outcome)"
          autofocus
        >
      </div>

      <div style="width:220px; min-width:180px;">
        <label class="muted">Where</label>
        <select name="kw_field">
          <option value="all" {% if kw_field == "all" %}selected{% endif %}>Everywhere</option>
          <option value="title" {% if kw_field == "title" %}selected{% endif %}>Title</option>
          <option value="excerpt" {% if kw_field == "excerpt" %}selected{% endif %}>Excerpt</option>
          <option value="body" {% if kw_field == "body" %}selected{% endif %}>Body text</option>
          <option value="values" {% if kw_field == "values" %}selected{% endif %}>Extracted values (codes)</option>
          <option value="url" {% if kw_field == "url" %}selected{% endif %}>URL</option>
          <option value="id" {% if kw_field == "id" %}selected{% endif %}>Document ID</option>
        </select>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:flex-end; flex:0 0 auto;">
      <div style="min-width:140px;">
        <label class="muted">&nbsp;</label>
        <button type="submit" class="btnlink" style="width:100%;">Search</button>
      </div>

      <div style="min-width:120px;">
        <label class="muted">&nbsp;</label>
        <a class="btnlink" style="width:100%; justify-content:center;"
           href="/ui/search?core={{ core }}">
          Clear
        </a>
      </div>
    </div>
  </div>

  <div class="muted" style="margin-top:8px;">
    Tip: Use normal words. We search title + excerpt + extracted values (human/model).
  </div>

  {# -------------------- Refinements (optional) -------------------- #}
  <div class="card" style="margin-top:12px; padding:12px;">
    <div class="muted" style="font-weight:700; margin-bottom:6px;">Narrow results (optional)</div>

    <label class="muted" style="display:flex; gap:8px; align-items:center; margin: 6px 0 10px 0;">
      <input
        type="checkbox"
        name="include_codes_topics"
        value="1"
        {% if include_codes_topics == "1" or include_codes_topics is none %}checked{% endif %}
        style="width:auto; margin:0;"
      >
      Also match Codes and Topics
    </label>

    <div class="row" style="margin:0;">
      <div style="min-width:220px;">
        <label class="muted">Scope</label>
        <select name="scope">
          <option value="all" {% if scope == "all" %}selected{% endif %}>All corpus</option>
          <option value="project" {% if scope == "project" %}selected{% endif %}>
            Current project{% if project_name %}: {{ project_name }}{% endif %}
          </option>
        </select>
      </div>

      <div class="grow">
        <label class="muted">Code</label>
        <select name="code">
          <option value="">(any)</option>
          {% set code_f = facets.get("codes_all_ss") or [] %}
          {% for i in range(0, code_f|length, 2) %}
            {% set val = code_f[i] %}
            {% set cnt = code_f[i+1] if (i+1) < (code_f|length) else 0 %}
            <option value="{{ val }}" {% if code == val %}selected{% endif %}>{{ val }} ({{ cnt }})</option>
          {% endfor %}
        </select>
        {% if (code_f|length) == 0 %}
          <div class="muted" style="margin-top:6px;">No codes in current results</div>
        {% endif %}
      </div>

      <div class="grow">
        <label class="muted">Topic</label>
        <select name="topic">
          <option value="">(any)</option>
          {% set topic_f = facets.get("topics_ss") or [] %}
          {% for i in range(0, topic_f|length, 2) %}
            {% set val = topic_f[i] %}
            {% set cnt = topic_f[i+1] if (i+1) < (topic_f|length) else 0 %}
            <option value="{{ val }}" {% if topic == val %}selected{% endif %}>{{ val }} ({{ cnt }})</option>
          {% endfor %}
        </select>
        {% if (topic_f|length) == 0 %}
          <div class="muted" style="margin-top:6px;">No topics in current results</div>
        {% endif %}
      </div>

      <div style="min-width:220px;">
        <label class="muted">Human coding completed</label>
        <select name="has_human">
          <option value="" {% if not has_human %}selected{% endif %}>(any)</option>
          <option value="1" {% if has_human == "1" %}selected{% endif %}>Yes</option>
          <option value="0" {% if has_human == "0" %}selected{% endif %}>No (needs coding)</option>
        </select>
      </div>

<!--      <div style="min-width:240px;">-->
<!--        <label class="muted">Has comments (Hypothesis)</label>-->
<!--        <select name="has_any_span">-->
<!--          <option value="" {% if not has_any_span %}selected{% endif %}>(any)</option>-->
<!--          <option value="1" {% if has_any_span == "1" %}selected{% endif %}>Yes</option>-->
<!--          <option value="0" {% if has_any_span == "0" %}selected{% endif %}>No</option>-->
<!--        </select>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

  {# -------------------- Advanced (collapsed) -------------------- #}
  <details style="margin-top:12px;">
    <summary class="muted" style="cursor:pointer;">Advanced search options</summary>
    <div style="margin-top:10px;">
      <label class="muted">Power query (Solr)</label>
      <input name="q" value="{{ q if q else '' }}" placeholder='e.g. title_txt:"fraud" AND source_s:"X"'>
      <div class="muted" style="margin-top:6px;">If filled, this overrides the keyword search.</div>
    </div>
  </details>
</form>

<div class="meta">
  <span class="pill">Results: {{ result.get("numFound", 0) }}</span>
</div>

<table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Title</th>
      <th>Published</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    {% set docs = (result.get("docs") or []) %}
    {% if docs|length == 0 %}
      <tr>
        <td colspan="4" class="muted">No results.</td>
      </tr>
    {% endif %}

    {% for d in docs %}
      {% set doc_id = d.get("document_id_s","") %}
      {% set title = (d.get("title_txt") or [""])[0] %}

      {% set _published = d.get("published_dt") %}
      {% if _published is iterable and _published is not string %}
        {% set published = (_published[0] if _published|length > 0 else "") %}
      {% else %}
        {% set published = (_published or "") %}
      {% endif %}

      <tr>
        <td><span class="mono">{{ doc_id[:8] }}</span></td>

        <td>
          {% if title %}
            {{ title }}
          {% else %}
            <span class="muted">(untitled)</span>
          {% endif %}
        </td>

        <td class="mono">{{ published if published else "—" }}</td>

        <td>
          <a class="btnlink" href="/ui/docs/{{ doc_id }}?core={{ core }}&back_url={{ back_url_enc }}">Open</a>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{# -------------------- Google-style pagination -------------------- #}
{% set total = (result.get("numFound", 0) | int) %}
{% set rows = 20 %}
{% set current_page = ((start|int) // rows) + 1 %}
{% set total_pages = ((total + rows - 1) // rows) if total > 0 else 1 %}
{% set window = 2 %}
{% set start_page = current_page - window %}
{% set end_page = current_page + window %}
{% if start_page < 1 %}{% set start_page = 1 %}{% endif %}
{% if end_page > total_pages %}{% set end_page = total_pages %}{% endif %}

<div class="row" style="gap:8px; align-items:center; margin-top:14px; flex-wrap:wrap;">
  {% if current_page > 1 %}
    <a class="btnlink"
       href="/ui/search?core={{ core }}&kw={{ kw or '' }}&kw_field={{ kw_field or 'all' }}&include_codes_topics={{ include_codes_topics or '1' }}&q={{ q or '' }}&scope={{ scope }}&code={{ code or '' }}&topic={{ topic or '' }}&has_human={{ has_human or '' }}&has_any_span={{ has_any_span or '' }}&start={{ ((current_page-2) * rows) }}">
      Prev
    </a>
  {% endif %}

  {% if start_page > 1 %}
    <a class="btnlink"
       href="/ui/search?core={{ core }}&kw={{ kw or '' }}&kw_field={{ kw_field or 'all' }}&include_codes_topics={{ include_codes_topics or '1' }}&q={{ q or '' }}&scope={{ scope }}&code={{ code or '' }}&topic={{ topic or '' }}&has_human={{ has_human or '' }}&has_any_span={{ has_any_span or '' }}&start=0">
      1
    </a>
    {% if start_page > 2 %}
      <span class="muted">…</span>
    {% endif %}
  {% endif %}

  {% for p in range(start_page, end_page + 1) %}
    {% if p == current_page %}
      <span class="pill">{{ p }}</span>
    {% else %}
      <a class="btnlink"
         href="/ui/search?core={{ core }}&kw={{ kw or '' }}&kw_field={{ kw_field or 'all' }}&include_codes_topics={{ include_codes_topics or '1' }}&q={{ q or '' }}&scope={{ scope }}&code={{ code or '' }}&topic={{ topic or '' }}&has_human={{ has_human or '' }}&has_any_span={{ has_any_span or '' }}&start={{ ((p-1) * rows) }}">
        {{ p }}
      </a>
    {% endif %}
  {% endfor %}

  {% if end_page < total_pages %}
    {% if end_page < total_pages - 1 %}
      <span class="muted">…</span>
    {% endif %}
    <a class="btnlink"
       href="/ui/search?core={{ core }}&kw={{ kw or '' }}&kw_field={{ kw_field or 'all' }}&include_codes_topics={{ include_codes_topics or '1' }}&q={{ q or '' }}&scope={{ scope }}&code={{ code or '' }}&topic={{ topic or '' }}&has_human={{ has_human or '' }}&has_any_span={{ has_any_span or '' }}&start={{ ((total_pages-1) * rows) }}">
      {{ total_pages }}
    </a>
  {% endif %}

  {% if current_page < total_pages %}
    <a class="btnlink"
       href="/ui/search?core={{ core }}&kw={{ kw or '' }}&kw_field={{ kw_field or 'all' }}&include_codes_topics={{ include_codes_topics or '1' }}&q={{ q or '' }}&scope={{ scope }}&code={{ code or '' }}&topic={{ topic or '' }}&has_human={{ has_human or '' }}&has_any_span={{ has_any_span or '' }}&start={{ (current_page * rows) }}">
      Next
    </a>
  {% endif %}
</div>

{% endblock %}

