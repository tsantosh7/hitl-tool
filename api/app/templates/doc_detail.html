{% extends "base.html" %}
{% block content %}

{# ---------- Helpers: handle Solr fields that can be str OR list ---------- #}
{% set doc_id = doc.get("document_id_s") or "" %}

{% set _title = doc.get("title_txt") %}
{% if _title is iterable and _title is not string %}
  {% set title = (_title[0] if _title|length > 0 else "") %}
{% else %}
  {% set title = (_title or "") %}
{% endif %}

{% set _excerpt = doc.get("excerpt_txt") %}
{% if _excerpt is iterable and _excerpt is not string %}
  {% set excerpt = (_excerpt[0] if _excerpt|length > 0 else "") %}
{% else %}
  {% set excerpt = (_excerpt or "") %}
{% endif %}

{% set _source = doc.get("source_s") %}
{% if _source is iterable and _source is not string %}
  {% set source = (_source[0] if _source|length > 0 else "") %}
{% else %}
  {% set source = (_source or "") %}
{% endif %}

{% set _dtype = doc.get("doc_type_s") %}
{% if _dtype is iterable and _dtype is not string %}
  {% set doc_type = (_dtype[0] if _dtype|length > 0 else "") %}
{% else %}
  {% set doc_type = (_dtype or "") %}
{% endif %}

{% set _published = doc.get("published_dt") %}
{% if _published is iterable and _published is not string %}
  {% set published = (_published[0] if _published|length > 0 else "") %}
{% else %}
  {% set published = (_published or "") %}
{% endif %}

{% set _url = doc.get("canonical_url_s") %}
{% if _url is iterable and _url is not string %}
  {% set canonical_url = (_url[0] if _url|length > 0 else "") %}
{% else %}
  {% set canonical_url = (_url or "") %}
{% endif %}

{# Back URL: prefer back_url, else return to search preserving core if available #}
{% set _core = core if core is defined else "" %}
{% set back_fallback = ("/ui/search?core=" ~ (_core|urlencode)) if _core else "/ui/search" %}
{% set back_href = back_url if back_url else back_fallback %}

<div class="row" style="align-items:center; justify-content:space-between;">
  <div>
    <h1 class="mono" style="margin-bottom:4px;">{{ doc_id[:8] }}</h1>
    <div class="muted" style="font-size: 12px;">
      Document ID hidden (shows first 8 chars).&nbsp;
      <button
        type="button"
        onclick="navigator.clipboard.writeText('{{ doc_id }}')"
        style="border:0; background:none; padding:0; cursor:pointer; text-decoration:underline; color:inherit;"
      >
        Copy full ID
      </button>
    </div>
  </div>

  <div class="row" style="gap:10px;">
    {% if canonical_url %}
      <a class="btnlink" href="{{ canonical_url }}" target="_blank" rel="noopener">Open original</a>
    {% else %}
      <span class="muted">No canonical URL</span>
    {% endif %}

    <a class="btnlink" href="{{ back_href }}">Back to Search</a>
  </div>
</div>

<h2 style="margin-top:10px;">
  {{ title if title else "(no title)" }}
</h2>

<div class="meta">
  {% if source %}<span class="pill">source: {{ source }}</span>{% endif %}
  {% if doc_type %}<span class="pill">type: {{ doc_type }}</span>{% endif %}
  {% if published %}<span class="pill">published: <span class="mono">{{ published }}</span></span>{% endif %}
  {% if canonical_url %}<span class="pill">has url</span>{% endif %}
</div>

{% if excerpt %}
  <div class="card">
    <h3>Excerpt</h3>
    <p>{{ excerpt }}</p>
  </div>
{% endif %}

<div class="card">
  <h3>Topics (HITL)</h3>
    {% if not run_id %}
      <div class="muted" style="font-size:12px; margin: 6px 0 10px 0;">
        No active topic run is set. Actions will try to use the active run automatically; if none exists, you’ll be prompted to create/activate one.
      </div>
    {% endif %}
  {# ---------------- Manual add: label only (no topic_key) ---------------- #}
  {% if user.role in ["admin", "reviewer"] %}
    <div class="card" style="margin: 10px 0 14px 0;">
      <h4 style="margin:0 0 8px 0;">Add / Accept topic</h4>
      <div class="muted" style="font-size:12px; margin-bottom:8px;">
        Type a topic name (e.g., “Sentencing”, “Evidence”, “Appeal outcome”). The system will assign an internal key automatically.
      </div>

      <form method="post" action="/ui/topics/accept" class="row" style="gap:10px; align-items:end;">
        <input type="hidden" name="document_id" value="{{ doc_id }}">
        <input type="hidden" name="run_id" value="{{ run_id or '' }}">

        <div class="grow">
          <label class="muted">Topic name</label>
          <input class="grow" name="topic_label" placeholder="e.g., Sentencing" required>
        </div>

        {# DO NOT send topic_key; backend will generate deterministically from label #}
        <button type="submit">Add Topic</button>
      </form>
    </div>
  {% endif %}

  {% if not topics or topics|length == 0 %}
    <div class="muted">No topics found for this document.</div>
  {% else %}
    <table class="table">
      <thead>
        <tr>
          <th>Topic</th>
          <th>Score</th>
          <th>Source</th>
          <th>Status</th>
          <th>Updated</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
      {% for t in topics %}
        {% set src = t.get("source") if t is mapping else t.source %}
        {% set lbl = t.get("topic_label") if t is mapping else t.topic_label %}
        {% set key = t.get("topic_key") if t is mapping else t.topic_key %}
        {% set sc  = t.get("score") if t is mapping else t.score %}
        {% set upd = t.get("updated_at") if t is mapping else t.updated_at %}
        {% set at  = (t.get("assignment_type") if t is mapping else t.assignment_type) %}
        {% set st  = (t.get("status") if t is mapping else t.status) %}

        <tr>
          <td><strong>{{ lbl }}</strong></td>
          <td class="mono">{{ "%.2f"|format(sc or 0) }}</td>
          <td><span class="pill">{{ src }}</span></td>
          <td class="mono">{{ (st or "") }}</td>
          <td class="mono">{{ upd or "" }}</td>

          <td class="actions">
  {# Accept/Reject for suggestions (non-human, active) #}
  {% if user.role in ["admin", "reviewer"] and (st not in ["deleted", "rejected"]) and (at != "human") %}

    {# Accept: convert the existing suggestion into a human label (no typing) #}
    <form method="post" action="/ui/topics/accept" style="display:inline;">
      <input type="hidden" name="document_id" value="{{ doc_id }}">
      <input type="hidden" name="run_id" value="{{ run_id or '' }}">
      <input type="hidden" name="topic_label" value="{{ lbl }}">
      <button type="submit">Accept</button>
    </form>

    {# Reject: hide the suggestion #}
    <form method="post" action="/ui/topics/reject" style="display:inline;" onsubmit="return confirm('Reject this suggested topic?');">
      <input type="hidden" name="document_id" value="{{ doc_id }}">
      <input type="hidden" name="topic_key" value="{{ key }}">
      <input type="hidden" name="run_id" value="{{ run_id or '' }}">
      <button class="danger" type="submit">Reject</button>
    </form>
  {% endif %}

  {# Remove only for ACTIVE human labels #}
  {% if user.role in ["admin", "reviewer"] and at == "human" and st == "active" %}
    <form method="post" action="/ui/topics/delete" style="display:inline;" onsubmit="return confirm('Remove this topic label from this document?');">
      <input type="hidden" name="document_id" value="{{ doc_id }}">
      <input type="hidden" name="topic_key" value="{{ key }}">
      <input type="hidden" name="run_id" value="{{ run_id or '' }}">
      <button class="warn" type="submit">Remove</button>
    </form>
  {% endif %}

  {% if st in ["deleted", "rejected"] %}
    <span class="muted">({{ st }})</span>
  {% endif %}
</td>

        </tr>
      {% endfor %}
      </tbody>
    </table>

    <div class="muted" style="font-size:12px; margin-top:10px;">
      Tip: “Accept” converts a suggestion into a human topic label (so it propagates). “Reject” hides that suggestion.
    </div>
  {% endif %}
</div>

<div class="card">
  <h3>Codes (Extracted Values)</h3>

  <div class="meta">
    <span class="pill">human-only: {{ code_stats.human_only }}</span>
    <span class="pill">model-only: {{ code_stats.model_only }}</span>
    <span class="pill">both: {{ code_stats.both }}</span>
    <span class="pill">disagreements: {{ code_stats.disagree }}</span>
  </div>

  {% if not codes_view or codes_view|length == 0 %}
    <div class="muted">No code values found for this document.</div>
  {% else %}
    <table class="table">
      <thead>
        <tr>
          <th style="width:220px;">Code</th>
          <th>Best value (prefers human normalized)</th>
          <th style="width:120px;">Source</th>
          <th style="width:140px;">Notes</th>
        </tr>
      </thead>

      <tbody>
      {% for r in codes_view %}
        <tr>
          <td class="mono"><strong>{{ r.code }}</strong></td>

          <td>
            {% if r.best %}
              {{ r.best }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}

            <div style="margin-top:6px;">
              <details>
                <summary class="muted" style="cursor:pointer;">Show details</summary>

                <div style="margin-top:10px;">
                  <div class="row" style="gap:12px; align-items:flex-start;">
                    <div class="grow">
                      <div class="muted" style="font-weight:600; margin-bottom:4px;">Human (normalized)</div>
                      {% if r.human_norm and r.human_norm|length > 0 %}
                        {% for v in r.human_norm %}
                          <span class="pill">{{ v }}</span>
                        {% endfor %}
                      {% else %}
                        <div class="muted">—</div>
                      {% endif %}

                      <div class="muted" style="font-weight:600; margin:10px 0 4px 0;">Human (raw)</div>
                      {% if r.human_raw and r.human_raw|length > 0 %}
                        {% for v in r.human_raw %}
                          <span class="pill">{{ v }}</span>
                        {% endfor %}
                      {% else %}
                        <div class="muted">—</div>
                      {% endif %}
                    </div>

                    <div class="grow">
                      <div class="muted" style="font-weight:600; margin-bottom:4px;">Model (normalized)</div>
                      {% if r.model_norm and r.model_norm|length > 0 %}
                        {% for v in r.model_norm %}
                          <span class="pill">{{ v }}</span>
                        {% endfor %}
                      {% else %}
                        <div class="muted">—</div>
                      {% endif %}

                      <div class="muted" style="font-weight:600; margin:10px 0 4px 0;">Model (raw)</div>
                      {% if r.model_raw and r.model_raw|length > 0 %}
                        {% for v in r.model_raw %}
                          <span class="pill">{{ v }}</span>
                        {% endfor %}
                      {% else %}
                        <div class="muted">—</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </details>
            </div>
          </td>

          <td>
            {% if r.source == "human" %}
              <span class="pill">Human</span>
            {% elif r.source == "model" %}
              <span class="pill">Model</span>
            {% elif r.source == "both" %}
              <span class="pill">Both</span>
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>

          <td>
            {% if r.disagree %}
              <span class="pill">⚠ disagree</span>
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

{% endblock %}
